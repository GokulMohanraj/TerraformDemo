trigger:
  branches:
    include:
      - master

pool:
  name: Default

variables:
  AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)  # Define your AWS access key ID as a variable
  AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)  # Define your AWS secret access key as a variable
  AWS_DEFAULT_REGION: 'ap-south-1'  # Define your AWS region

stages:
  - stage: InstallTerraform
    jobs:
      - job: InstallTerraformJob
        steps:
          - script: |
              # Install Terraform
              wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt update && sudo apt install terraform -y
              terraform -version  # Verify Terraform installation
            displayName: 'Install Terraform'
  
  - stage: TerraformApply
    dependsOn: InstallTerraform
    jobs:
      - job: TerraformApplyJob
        steps:
          # AWSCLI task to configure AWS credentials directly via environment variables
          - task: AWSCLI@1  # AWS CLI task to authenticate AWS
            inputs:
              regionName: $(AWS_DEFAULT_REGION)  # Use the AWS region variable
              awsCommand: 'sts get-caller-identity'  # Verify AWS credentials
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)  # Set AWS access key from variables
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)  # Set AWS secret key from variables
              displayName: 'Configure AWS CLI'

          # Terraform Init
          - script: |
              terraform init
            displayName: 'Initialize Terraform'

          # Terraform Plan
          - script: |
              terraform plan -out=tfplan
            displayName: 'Terraform Plan'

          # Terraform Apply
          - script: |
              terraform apply -auto-approve tfplan
            displayName: 'Terraform Apply'
