trigger:
  branches:
    include:
      - master
pool:
  name: Default
variables:
  AWS_SERVICE_CONNECTION: 'AWS-SC'
  AWS_DEFAULT_REGION: 'ap-south-1'
stages:
  - stage: InstallTerraform
    jobs:
      - job: InstallTerraformJob
        steps:
          - script: |
              # Install Terraform
              wget -O - https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
              echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
              sudo apt update && sudo apt install terraform -y
              terraform -version  # Verify Terraform installation
            displayName: 'Install Terraform'
  
  - stage: TerraformApply
    dependsOn: InstallTerraform 
    jobs:
      - job: TerraformApplyJob
        steps:
          - task: AWSCLI@1  # AWS CLI task to set up AWS credentials
            inputs:
              awsCredentials: 'AWS-SC'  # Reference the AWS service connection here
              regionName: 'ap-south-1'  # Specify your AWS region
              awsCommand: 'sts get-caller-identity'  # This verifies that the AWS CLI can successfully access AWS
              displayName: 'Configure AWS CLI'

          # Terraform Init
          - script: |
              terraform init
            displayName: 'Initialize Terraform'

          # Terraform Plan
          - script: |
              terraform plan -out=tfplan
            displayName: 'Terraform Plan'

          # Terraform Apply
          - script: |
              terraform apply -auto-approve tfplan
            displayName: 'Terraform Apply'
